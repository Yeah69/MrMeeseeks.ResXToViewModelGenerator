using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;

namespace MrMeeseeks.ResXToViewModelGenerator
{
	public static class Templating
	{
		public static string Render(
			string @namespace,
			string name,
			IReadOnlyDictionary<string, string> defaultKeyValues,
			IReadOnlyDictionary<string, IReadOnlyDictionary<string, string>> culturalKeyValues)
		{
			var implementations = culturalKeyValues
				.Select(kvp => Create(kvp.Key, kvp.Key, kvp.Value))
				.Prepend(Create("Default", "iv", defaultKeyValues))
				.Append(Create("Key", "iv", defaultKeyValues.ToDictionary(kvp => kvp.Key, kvp => kvp.Key)))
				.ToList();

			StringBuilder stringBuilder = new ();
			stringBuilder.AppendLine(@$"#nullable enable
using System;
using System.Collections.Generic;
using System.Collections.ObjectModel;
using System.ComponentModel;
using System.Globalization;

// ------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
// ------------------------------------------------------------------------------


namespace {@namespace}
{{
	public interface I{name}ViewModel : INotifyPropertyChanged
	{{
		CultureInfo CultureInfo {{ get; }}");
			foreach (var propertyName in implementations[0].Properties.Select(p => p.Name))
			{
				stringBuilder.AppendLine($"		string {propertyName} {{ get; }}");
			}
			stringBuilder.AppendLine(@$"
		ISettable{name}ViewModel AsSettable();
	}}
	public interface ISettable{name}ViewModel : INotifyPropertyChanged
	{{");
			foreach (var propertyName in implementations[0].Properties.Select(p => p.Name))
			{
				stringBuilder.AppendLine($"		string {propertyName} {{ set; }}");
			}
			stringBuilder.AppendLine(@$"
    }}
	
	public interface I{name}OptionViewModel : INotifyPropertyChanged
	{{
		CultureInfo CultureInfo {{ get; }}
	}}

	public interface ICurrent{name}ViewModel : INotifyPropertyChanged
	{{
		I{name}ViewModel Current{name} {{ get; }}

		I{name}OptionViewModel CurrentOption {{ get; set; }}
        
		IReadOnlyList<I{name}OptionViewModel> AvailableOptions {{ get; }}

		void ShowKeys();
	}}
        
	public sealed class Current{name}ViewModel : ICurrent{name}ViewModel
	{{
		private I{name}ViewModel _current{name};
		private I{name}OptionViewModel _currentOption;
		public event PropertyChangedEventHandler? PropertyChanged;

		public Current{name}ViewModel()
		{{
			AvailableOptions = new ReadOnlyCollection<I{name}OptionViewModel>(
				new List<I{name}OptionViewModel>
				{{");
			
			foreach (var resXImplementation in implementations.Take(implementations.Count - 1))
			{
				stringBuilder.AppendLine($"					new {resXImplementation.Name }{name}OptionViewModel(),");
			}
			stringBuilder.AppendLine(@$"
				}});
			_currentOption = AvailableOptions[0];
			_current{name} = Create{name}(_currentOption);
		}}

		public I{name}OptionViewModel CurrentOption
		{{
			get => _currentOption;
			set
			{{
				if (_currentOption == value) return;
				_currentOption = value;
				_current{name} = Create{name}(value);
				PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(CurrentOption)));
				PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(nameof(Current{name})));
			}}
		}}

		private I{name}ViewModel Create{name}(I{name}OptionViewModel option) => ((option as I{name}OptionViewModelInternal) ?? new Default{name}OptionViewModel()).Create();

		public I{name}ViewModel Current{name} => _current{name};

		public void ShowKeys() => CurrentOption = new Key{name}OptionViewModel();

		public IReadOnlyList<I{name}OptionViewModel> AvailableOptions {{ get; }}

		public interface I{name}OptionViewModelInternal : I{name}OptionViewModel
		{{
			I{name}ViewModel Create();
		}}
");
			
			foreach (var implementation in implementations)
			{
				stringBuilder.AppendLine(@$"		private class {implementation.Name}{name}OptionViewModel : I{name}OptionViewModelInternal
		{{
#pragma warning disable 0067
			public event PropertyChangedEventHandler? PropertyChanged;
#pragma warning restore 0067

			public CultureInfo CultureInfo {{ get; }} = CultureInfo.GetCultureInfo(""{implementation.LanguageCode}"");

			public I{name}ViewModel Create() => new {implementation.Name}{name}ViewModel();
		}}");
			}
			
			foreach ((string Name, string LanguageCode, IReadOnlyList<(string Name, string BackingFieldName, string Value)> Properties) implementation in implementations)
			{
				stringBuilder.AppendLine(@$"		private class {implementation.Name}{name}ViewModel : I{name}ViewModel, ISettable{name}ViewModel
        {{
#pragma warning disable 0067
			public event PropertyChangedEventHandler? PropertyChanged;
#pragma warning restore 0067

			public CultureInfo CultureInfo
			{{
				get
				{{
					try
					{{
						return CultureInfo.GetCultureInfo(""{implementation.LanguageCode}"");
					}}
					catch (Exception)
					{{
						// ignored
					}}
					return CultureInfo.InvariantCulture;
				}}
			}} 
");
				foreach (var resXImplementationProperty in implementation.Properties)
				{
					stringBuilder
						.AppendLine($"			private string {resXImplementationProperty.BackingFieldName} = {resXImplementationProperty.Value};")
						.AppendLine($"			public string {resXImplementationProperty.Name}")
						.AppendLine($"			{{")
						.AppendLine($"			    get => {resXImplementationProperty.BackingFieldName};")
						.AppendLine($"			    set")
						.AppendLine($"			    {{")
						.AppendLine($"			        if({resXImplementationProperty.BackingFieldName} != value)")
						.AppendLine($"			        {{")
						.AppendLine($"			            {resXImplementationProperty.BackingFieldName} = value;")
						.AppendLine($"			            PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(\"{resXImplementationProperty.Name}\"));")
						.AppendLine($"			        }}")
						.AppendLine($"			    }}")
						.AppendLine($"			}}");
				}
				stringBuilder
					.AppendLine($"		    public ISettable{name}ViewModel AsSettable() => this;")
					.AppendLine("		}");
			}
			stringBuilder.AppendLine(@"	}
}
#nullable disable");
			

			return stringBuilder.ToString();


			static (string Name, string LanguageCode, IReadOnlyList<(string Name, string BackingFieldName, string Value)> Properties) Create(
				string name,
				string languageCode,
				IReadOnlyDictionary<string, string> propertyMapping)
			{
				ISet<string> takenNames = new HashSet<string>(propertyMapping.Keys);
				return (
					name.Replace("-", "_"), // Escape minuses of language codes for the names of types
					languageCode,
					propertyMapping
						.Select(kvp => (kvp.Key, FindBackingFieldName(kvp.Key, takenNames), ValueToLiteral(kvp.Value)))
						.ToList());
				
				static string ValueToLiteral(string input) => 
					Microsoft.CodeAnalysis.CSharp.SymbolDisplay.FormatLiteral(input, true);

				static string FindBackingFieldName(string propertyName, ISet<string> takenNames)
				{
					var i = 0;
					// ReSharper disable once RedundantAssignment
					while ($"_{propertyName}{i++}" is {} backingFieldName && !takenNames.Contains(backingFieldName))
					{
						takenNames.Add(backingFieldName);
						return backingFieldName;
			}

					throw new InvalidOperationException("Shouldn't be possible!");
		}
	}
}
	}
}
